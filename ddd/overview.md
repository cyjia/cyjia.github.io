# 领域驱动设计
Eric Evans在2003年完成《领域驱动设计-软件核心复杂性应对之道》一书，随后领域驱动设计被人们广泛提及。
## 释义
*领域* 软件用于解决某方面的问题，问题所处的环境就是领域。比如，小汽车摇号软件的领域就是申请人、审核人以及他们共同协作完成申请、审核、摇号的活动。
*设计* 要解释清楚什么是设计就要从宏观上看软件开发活动。宏观上看，软件开发活动就是紧扣用户需求从领域活动中抽象出用于解决问题的模型，然后把模型映射到实现软件的类、方法、基础设施操作等软件元素，最后再用具体的编程语言、工具库实现。模型到软件元素的映射过程就是设计。
*驱动* 顾名思义就是推动，使之前进。这里强调以领域作为软件设计的驱动力，与之相对的是技术驱动，技术驱动也是DDD之前大家不由自主的选择。技术驱动的例子很多，比如数据库技术驱动的设计用数据表、触发器、存储过程等元素映射领域活动，UI技术驱动的设计会用控件、页面等元素映射领域活动。[领域驱动 VS 技术驱动](http://)
## 包含什么
领域驱动设计的内容包括统一语言，基本构造块，重构及柔性设计，战略设计等四大部分。
### 统一语言
软件开发活动是需求、建模、设计、实现、运行5个过程构成的闭环，每个过程都涉及多种角色并产生大量交付物，这些角色在每个过程内部和过程之间都有大量沟通发生，通过实践统一语言可以提高沟通效率、降低沟通成本。统一语言就是一套描述业务模型的技术词汇（包括句子吗？），这套语言以业务用语为主并结合了少量软件技术术语，其目的是在业务和技术人员之间沟通软件如何执行业务活动。比如，一个用于销售的软件，他的统一语言就包括订单实体，下单服务，订单已提交事件等词汇，这些词汇会出现在业务和技术人员口头和书面沟通中，也会出现在代码、界面中。如果不用统一语言，就可能会出现业务人员用订单、下单、订单提交时等词汇，而技术人员用Order表，Order表记录入库处理，Order表插入触发器等词汇。

能照搬业务领域的术语吗？不能。统一语言是描述业务模型的词汇，业务模型不是业务领域的直接映射而是对业务领域的抽象，因此照搬业务领域的术语是不行的。模型是对事实满足特定目的的抽象，比如钢铁冶炼工艺涉及到加料控制、温度控制、调合金、采样、钢包维修等等，一个生产管理软件的业务模型重点关注原料、产出、设备器具的数量、规格，而一个生产过程控制软件的业务模型则关注每炉钢的加料顺序、钢种、实时温度、最近抽样结果等。
### 基本构造块
基本构造块是描述模型的几类基本元素，业务模型映射到基本构造块，基本构造块映射到软件元素。软件元素由思考范式决定，典型的思考范式有面向对象、面向过程和面向规则等三种，而面向对象是最接近人的思维方式，因此通常采取以面向对象为主，结合面向过程和面向规则的思维方式。基本构造块有以下六个。
#### 实体
实体来源于面向对象思考范式中的对象概念和业务领域中需要唯一标识的业务对象。比如，订单，业务活动中需要用订单编号区别不同的订单，订单就是实体。在面向对象编程语言的实现中（比如Java），通常会在创建对象时为对象生成唯一标识，这个唯一标识和实体的唯一标识不是同一个概念，同一个订单实体，可以创建不同的对象，他们有不同的对象标识，但有相同的实体标识，如果实体标识相同，就可以认为两个实体对象相同。
#### 值对象
值对象是另一种特殊对象，对应业务领域中不需要唯一标识的描述性业务对象。比如，数量，金额，长度，汇率等。
#### 聚合
聚合是一组相关对象，受业务规则约束，这组相关对象需要同时进行修改，只允许在限定的时间内对象之间不满足业务规则。聚合有助于发现紧密想过的对象群，减少对象间的关联。
#### 领域服务
领域服务是业务活动的直接映射，比如创建订单，发货等等。领域服务和应用服务不同，应用服务除了调用领域服务外还会调用其他基础设施服务以完成应用系统的所有动作。以发货为例，领域服务需要更新订单、库存对象并创建发货单，应用服务除了调用领域服务还要调用基础设施服务给用户发送通知短信。这个例子中，领域服务负责的是订单、库存、发货单等领域对象，而发送通知短信、邮件则因应用的不同而有区别，在应用服务中是调用基础设施服务完成。当然，发送通知短信的系统中，发送通知短信也是一个业务领域，只不过在发货业务领域他不是重点。
#### 领域事件
领域事件是业务活动中产生的受业务人员关注的事件，比如足球比赛中换人、黄牌、进球、中场休息等。领域事件不同于系统事件，在一个足球比赛技术统计系统中，会有大量对象新建、销毁、状态更新的系统事件，但只有换人、黄牌、进球、射门等受统计人员关心的事件才是领域事件。
#### 资源库
资源库是对文件、数据库、外部系统等存储设施的抽象，他就是领域对象的仓库。
#### 工厂
工厂用于新建或重建对象。
### 重构及柔性设计
领域设计也不是一下就能做到最完美的设计，需要大量的重构。在遇到新需求时，就是重构的时机，这时大家会重新审视现有的设计，看他能否容易实现新需求。当发现需要很麻烦才能实现新需求时，这说明现有的设计还没有接近问题的本质，这就是重构的最佳时机。这时候应该和领域专家一起讨论新需求，从中发现遗漏的领域概念。或者重新思考现有设计。往往会有突破性认识，发现一个更简单更灵活的设计能满足新需求。
除了重构，在设计中遵循一些原则也能为以后的灵活性和扩展性埋下伏笔。这些原则包括
- 揭示意图的接口
给函数、类起名字时注意描述他们的目的和影响，而不是描述他们的内部实现。
- 无副作用函数
无副作用函数是一类只返回值但没有可见影响的对象，大多数情况下他不会改变对象状态，只会新建对象，极少情况下他也会改变对象状态，但所改变的状态不影响对象的行为也无法从外部观察到。

- 断言
仍然有一部函数要改变实体的状态，对这部分函数利用断言描述方法前置和后置状态。如果所用语言无法支持断言，就用测试或者文档表达。

- 概念轮廓
铁板一块的模型功能重复，外部接口难理解。但是，无目的地拆分类和方法也不会使系统更好理解。结合对领域概念的内聚性把类、和方法拆分到一些内聚单元中。在不断地重构过程中，注意观察引起变化的因素，寻找隐含的概念轮廓。

- 声明式设计

- 独立类
耦合性越低越容易理解、容易变化。独立类不依赖任何别的类。尽量把核心计算逻辑重构到独立类中。

- 封闭的操作
操作的参数和返回值都是同一种类型，常见于值对象。

### 战略设计
#### Bounded Context(限界上下文)
大型系统往往有多个模型，每个模型有自己的上下文。比如，一个钢铁厂的生产管理系统有作业、生产计划、质量检验、库存等模型，这些模型中都会涉及到钢板这一概念，但在不同的模型中对钢板的属性、生命周期有不同的理解。如果不清晰地定义模型的上下文往往会带来交流的混乱。

#### 上下文映射
不同限界上下文之间有关联时会互相渗透，最终导致两边的模型都不伦不类。应该明确地表达不同上下文之间映射转换关系，使上下文保持自己模型的完整性和内聚性。上下文映射的模式有如下几种：
* 共享内核
* 客户和供应方
* 尊奉者
* 防腐层
* 开放主机服务
* 发布语言
